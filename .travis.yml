language: python
sudo: false
cache:
  pip: false
env:
  global:
  - AWS_DEFAULT_REGION=us-east-1
jobs:
  include:
  - stage: unit tests
    python: '3.6'
    install:
    - pip install six
    - python setup.py install
    - pip install -U -r requirements-test.txt
    - pip install codacy-coverage
    script:
    - if [ "$TRAVIS_BRANCH" != "doc" ]; then
      invoke test --no-flake --no-post; fi
    - if [ "$TRAVIS_BRANCH" == "production" ]; then
      invoke test --deployment; fi
    after_success:
    - echo "finished running tests on repo"
    - python-codacy-coverage -r coverage.xml
    - if [ "$TRAVIS_BRANCH" == "production" ]; then
      tibanna_4dn deploy_pony;
      tibanna_4dn deploy_core -n start_run;
      tibanna_4dn deploy_core -n run_task;
      tibanna_4dn deploy_core -n check_task;
      tibanna_4dn deploy_core -n update_ffmeta;
      tibanna_cgap deploy_zebra;
      tibanna_cgap deploy_core -n start_run;
      tibanna_cgap deploy_core -n run_task;
      tibanna_cgap deploy_core -n check_task;
      tibanna_cgap deploy_core -n update_ffmeta;
      tibanna_cgap deploy_zebra -s tmp_md5;
      tibanna_cgap deploy_core -n start_run -s tmp_md5;
      tibanna_cgap deploy_core -n run_task -s tmp_md5;
      tibanna_cgap deploy_core -n check_task -s tmp_md5;
      tibanna_cgap deploy_core -n update_ffmeta -s tmp_md5;
      tibanna_4dn deploy_pony -g default_luisa -S;
      tibanna_4dn deploy_core -g default_luisa -n start_run;
      tibanna_4dn deploy_core -g default_luisa -n run_task;
      tibanna_4dn deploy_core -g default_luisa -n check_task;
      tibanna_4dn deploy_core -g default_luisa -n update_ffmeta;
      tibanna_4dn deploy_pony -s tmp_md5;
      tibanna_4dn deploy_core -n start_run -s tmp_md5;
      tibanna_4dn deploy_core -n run_task -s tmp_md5;
      tibanna_4dn deploy_core -n check_task -s tmp_md5;
      tibanna_4dn deploy_core -n update_ffmeta -s tmp_md5;
      fi
